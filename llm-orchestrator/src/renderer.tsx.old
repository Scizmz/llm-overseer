import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { useStore } from './store';
import './native.css';

// Import your existing components
import ChatPanel from './components/ChatPanel';
import NetworkDashboard from './components/NetworkDashboard';
import SettingsPanel from './components/SettingsPanel';
import Sidebar from './components/Sidebar';
import StatusBar from './components/StatusBar';

// Custom Title Bar Component (draggable)
function CustomTitleBar({ onMinimize, onMaximize, onClose, isMaximized, isFocused }: {
  onMinimize: () => void;
  onMaximize: () => void;
  onClose: () => void;
  isMaximized: boolean;
  isFocused: boolean;
}) {
  const [platform, setPlatform] = useState<string>('');

  useEffect(() => {
    if (window.electronAPI?.getPlatformInfo) {
      window.electronAPI.getPlatformInfo().then((info: any) => {
        setPlatform(info.platform);
      });
    }
  }, []);

  return (
    <div className="custom-title-bar">
      {/* Centered App Title */}
      <div className="title-bar-title">LLM Orchestrator</div>
      
      {/* macOS Controls (left side) */}
      {platform === 'darwin' && (
        <div className="window-controls-macos">
          <button
            onClick={onClose}
            className={`macos-control-btn close ${!isFocused ? 'unfocused' : ''}`}
            onMouseEnter={(e) => { e.currentTarget.textContent = '‚úï'; }}
            onMouseLeave={(e) => { e.currentTarget.textContent = ''; }}
          />
          <button
            onClick={onMinimize}
            className={`macos-control-btn minimize ${!isFocused ? 'unfocused' : ''}`}
            onMouseEnter={(e) => { e.currentTarget.textContent = '‚àí'; }}
            onMouseLeave={(e) => { e.currentTarget.textContent = ''; }}
          />
          <button
            onClick={onMaximize}
            className={`macos-control-btn maximize ${!isFocused ? 'unfocused' : ''}`}
            onMouseEnter={(e) => { e.currentTarget.textContent = isMaximized ? '‚åÑ' : '‚åÉ'; }}
            onMouseLeave={(e) => { e.currentTarget.textContent = ''; }}
          />
        </div>
      )}

      {/* Windows/Linux Controls (right side) */}
      {platform !== 'darwin' && (
        <div className="window-controls-win">
          <button
            onClick={onMinimize}
            className={`win-control-btn ${!isFocused ? 'unfocused' : ''}`}
          >
            ‚éØ
          </button>
          <button
            onClick={onMaximize}
            className={`win-control-btn ${!isFocused ? 'unfocused' : ''}`}
          >
            {isMaximized ? '‚ùê' : '‚òê'}
          </button>
          <button
            onClick={onClose}
            className="win-control-btn close"
          >
            ‚úï
          </button>
        </div>
      )}
    </div>
  );
}

// Custom Menu Bar Component
function CustomMenuBar() {
  const [activeMenu, setActiveMenu] = useState<string | null>(null);

  const menuItems = [
    { id: 'file', label: 'File' },
    { id: 'edit', label: 'Edit' },
    { id: 'view', label: 'View' },
    { id: 'models', label: 'Models' },
    { id: 'network', label: 'Network' },
    { id: 'tools', label: 'Tools' },
    { id: 'help', label: 'Help' }
  ];

  const handleMenuClick = (menuId: string) => {
    setActiveMenu(activeMenu === menuId ? null : menuId);
    // TODO: Implement dropdown menus
    console.log(`${menuId} menu clicked`);
  };

  return (
    <div className="custom-menu-bar">
      {menuItems.map(item => (
        <button
          key={item.id}
          onClick={() => handleMenuClick(item.id)}
          className={`menu-item ${activeMenu === item.id ? 'active' : ''}`}
        >
          {item.label}
        </button>
      ))}
    </div>
  );
}

// Custom Window Controls Component (kept separate for positioning)
function WindowControls({ onMinimize, onMaximize, onClose, isMaximized, isFocused }: {
  onMinimize: () => void;
  onMaximize: () => void;
  onClose: () => void;
  isMaximized: boolean;
  isFocused: boolean;
}) {
  const [platform, setPlatform] = useState<string>('');

  useEffect(() => {
    if (window.electronAPI?.getPlatformInfo) {
      window.electronAPI.getPlatformInfo().then((info: any) => {
        setPlatform(info.platform);
      });
    }
  }, []);

  // macOS style controls
  if (platform === 'darwin') {
    return (
      <div className="window-controls-macos">
        <button
          onClick={onClose}
          className={`macos-control-btn close ${!isFocused ? 'unfocused' : ''}`}
          onMouseEnter={(e) => { e.currentTarget.textContent = '‚úï'; }}
          onMouseLeave={(e) => { e.currentTarget.textContent = ''; }}
        />
        <button
          onClick={onMinimize}
          className={`macos-control-btn minimize ${!isFocused ? 'unfocused' : ''}`}
          onMouseEnter={(e) => { e.currentTarget.textContent = '‚àí'; }}
          onMouseLeave={(e) => { e.currentTarget.textContent = ''; }}
        />
        <button
          onClick={onMaximize}
          className={`macos-control-btn maximize ${!isFocused ? 'unfocused' : ''}`}
          onMouseEnter={(e) => { e.currentTarget.textContent = isMaximized ? '‚åÑ' : '‚åÉ'; }}
          onMouseLeave={(e) => { e.currentTarget.textContent = ''; }}
        />
      </div>
    );
  }

  // Windows/Linux style controls
  return (
    <div className="window-controls-win">
      <button
        onClick={onMinimize}
        className={`win-control-btn ${!isFocused ? 'unfocused' : ''}`}
      >
        ‚éØ
      </button>
      <button
        onClick={onMaximize}
        className={`win-control-btn ${!isFocused ? 'unfocused' : ''}`}
      >
        {isMaximized ? '‚ùê' : '‚òê'}
      </button>
      <button
        onClick={onClose}
        className="win-control-btn close"
      >
        ‚úï
      </button>
    </div>
  );
}

// Custom Toolbar Component
function CustomToolbar({ currentView, onViewChange }: {
  currentView: string;
  onViewChange: (view: string) => void;
}) {
  return (
    <div className="custom-toolbar">
      {/* App Icon and Title */}
      <div className="toolbar-brand">
        <div className="toolbar-icon">‚ö°</div>
        LLM Orchestrator
      </div>

      {/* Navigation Menu */}
      <div className="toolbar-nav">
        {[
          { id: 'chat', label: 'Chat', icon: 'üí¨' },
          { id: 'network', label: 'Network', icon: 'üåê' },
          { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
        ].map(item => (
          <button
            key={item.id}
            onClick={() => onViewChange(item.id)}
            className={`toolbar-nav-btn ${currentView === item.id ? 'active' : ''}`}
          >
            <span>{item.icon}</span>
            <span>{item.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
}

// Main App Component
function App() {
  const [currentView, setCurrentView] = useState<'chat' | 'network' | 'settings'>('chat');
  const [systemStatus, setSystemStatus] = useState<string>('Ready');
  const [windowState, setWindowState] = useState({
    maximized: false,
    fullscreen: false,
    focused: true
  });

  // Window control handlers
  const handleMinimize = async () => {
    if (window.electronAPI?.windowMinimize) {
      await window.electronAPI.windowMinimize();
    }
  };

  const handleMaximize = async () => {
    if (window.electronAPI?.windowMaximize) {
      const result = await window.electronAPI.windowMaximize();
      if (result) {
        setWindowState(prev => ({ ...prev, maximized: result.maximized }));
      }
    }
  };

  const handleClose = async () => {
    if (window.electronAPI?.windowClose) {
      await window.electronAPI.windowClose();
    }
  };

  // Network scan handler
  const handleNetworkScan = async () => {
    try {
      setSystemStatus("Starting network scan...");
      if (window.electronAPI?.startNetworkScan) {
        await window.electronAPI.startNetworkScan();
        setSystemStatus("Network scan in progress...");
      }
    } catch (error) {
      console.error('Failed to start network scan:', error);
      setSystemStatus("Network scan failed");
    }
  };

  // Setup window state listeners
  useEffect(() => {
    const unsubscribe1 = window.electronAPI?.onWindowStateChanged?.((state: any) => {
      setWindowState(prev => ({
        ...prev,
        maximized: state.maximized,
        fullscreen: state.fullscreen
      }));
    });

    const unsubscribe2 = window.electronAPI?.onWindowFocusChanged?.((state: any) => {
      setWindowState(prev => ({
        ...prev,
        focused: state.focused
      }));
    });

    // Get initial window state
    if (window.electronAPI?.getWindowState) {
      window.electronAPI.getWindowState().then((state: any) => {
        if (state) {
          setWindowState({
            maximized: state.isMaximized,
            fullscreen: state.isFullScreen,
            focused: state.isFocused
          });
        }
      });
    }

    return () => {
      unsubscribe1?.();
      unsubscribe2?.();
    };
  }, []);

  return (
    <div className="app-container">
      
      {/* Custom Title Bar (draggable) */}
      <CustomTitleBar
        onMinimize={handleMinimize}
        onMaximize={handleMaximize}
        onClose={handleClose}
        isMaximized={windowState.maximized}
        isFocused={windowState.focused}
      />

      {/* Custom Menu Bar */}
      <CustomMenuBar />

      {/* Custom Toolbar */}
      <CustomToolbar
        currentView={currentView}
        onViewChange={(view) => setCurrentView(view as 'chat' | 'network' | 'settings')}
      />

      {/* Main Content Area */}
      <div className="main-content">
        
        {/* Left Panel - Sidebar */}
        <div className="sidebar-container">
          <Sidebar
            onSettings={() => setCurrentView('settings')}
            onViewChange={setCurrentView}
            currentView={currentView}
          />
        </div>

        {/* Main Content */}
        <div className="content-container">
          {/* Content based on current view */}
          {currentView === 'chat' && (
            <ChatPanel />
          )}
          
          {currentView === 'network' && (
            <NetworkDashboard />
          )}
          
          {currentView === 'settings' && (
            <SettingsPanel />
          )}
        </div>
      </div>

      {/* Status Bar */}
      <div className="status-bar">
        <StatusBar status={systemStatus} />
        <div className="status-bar-content">
          {systemStatus}
        </div>
      </div>
    </div>
  );
}

// Initialize React app
const container = document.getElementById('root');
if (container) {
  const root = createRoot(container);
  root.render(<App />);
} else {
  console.error('Root container not found');
}
